<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Administrador - Rifa Pro Fondos</title>
  <style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    padding: 20px;
  }

  h1, h2 {
    text-align: center;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
    gap: 8px;
    max-width: 600px;
    margin: 20px auto;
  }

  .cell {
    background-color: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    text-align: center;
    padding: 10px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .green { background-color: #a5d6a7; }
  .yellow { background-color: #fff59d; }

  .section {
    max-width: 600px;
    margin: 20px auto;
    background-color: white;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ccc;
    text-align: center;
  }

  .modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    width: 300px;
  }

  .modal-content input,
  .modal-content select {
    width: 100%;
    padding: 8px;
    margin: 8px 0;
    border-radius: 4px;
    border: 1px solid #ccc;
  }

  #copyBtn {
    display: block;
    margin: 10px auto;
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
  }

  #copyBtn:hover {
    background-color: #0056b3;
  }

  .progress-container {
    margin: 10px auto;
    width: 100%;
    max-width: 600px;
  }

  .progress-bar {
    background-color: #ddd;
    border-radius: 8px;
    overflow: hidden;
    height: 25px;
    margin-bottom: 10px;
    position: relative;
    display: flex;
  }

  .verde { background-color: #81c784; height: 100%; }
  .amarillo { background-color: #fff176; height: 100%; }
  .blue { background-color: #90caf9; }


  .progress-text {
    position: absolute;
    width: 100%;
    text-align: center;
    font-weight: bold;
    line-height: 25px;
  }

  .solicitud {
    text-align: left;
    background-color: #f9f9f9;
    border: 1px dashed #aaa;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 12px;
    font-size: 0.95em;
  }

  .solicitud button {
    margin-right: 10px;
    padding: 6px 12px;
    font-size: 0.9em;
    cursor: pointer;
    border: none;
    border-radius: 5px;
  }

  .solicitud button.aprobar {
    background-color: #4CAF50;
    color: white;
  }

  .solicitud button.cancelar {
    background-color: #f44336;
    color: white;
  }

  #filtroEstado {
    display: block;
    margin: 0 auto 10px auto;
    padding: 8px;
    font-weight: bold;
  }
  .boton-home {
      margin-top: 20px;
      display: inline-block;
      text-align: center;
      padding: 10px 20px;
      background: #28a745;
      color: white;
      border-radius: 6px;
      text-decoration: none;
    }
</style>

</head>
<body>

<h1>Panel de Administraci√≥n</h1>
<div class="grid" id="grid"></div>
<div class="section">
  <h2>N√∫meros disponibles:</h2>
  <p id="availableNumbers"></p>
  <button id="copyBtn">Copiar mensaje</button>
</div>

<div class="section">
  <h2>Resumen</h2>
  <div id="resumenEstadisticas"></div>
  <div class="progress-container">
    <div class="progress-bar">
      <div id="barraVendidosMeta" class="verde"></div>
      <div id="barraPendientesMeta" class="amarillo"></div>
      <div class="progress-text" id="textoMeta"></div>
    </div>
    <div class="progress-bar">
      <div id="barraVendidos" class="verde"></div>
      <div id="barraPendientes" class="amarillo"></div>
      <div class="progress-text" id="textoTotal"></div>
    </div>
  </div>
</div>

<div class="section">
  <h2>Lista de inscritos</h2>
  <select id="filtroEstado">
    <option value="todos">Todos</option>
    <option value="vendido">Vendidos</option>
    <option value="pendiente">Pendientes</option>
  </select>
  <div id="listaParticipantes"></div>
</div>

<div class="section">
    <h2>Solicitudes de n√∫meros</h2>
    <div id="noticiasAdmin">Cargando...</div>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Editar n√∫mero <span id="numeroModal"></span></h3>
    <input type="text" id="nombreInput" placeholder="Nombre" />
    <input type="text" id="apellidoInput" placeholder="Apellido" />
    <select id="estadoInput">
      <option value="vendido">Vendido</option>
      <option value="pendiente">Pendiente</option>
      <option value="disponible">Disponible</option>
    </select>
    <button onclick="guardarCambios()">Guardar</button>
    <button onclick="cerrarModal()">Cancelar</button>
  </div>
</div>
<a href="index.html" class="boton-home">‚Üê Volver al Inicio</a>
<footer style="text-align: center; margin-top: 40px; font-size: 0.9em; color: #777;">
  Hecho por el propio <strong>Juan David Giraldo Regino</strong> :).
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCmfnmwARjEAwIO0AL1ARHW8JVelcR8ZWc",
    authDomain: "rifa-pro-fondos.firebaseapp.com",
    projectId: "rifa-pro-fondos",
    storageBucket: "rifa-pro-fondos.appspot.com",
    messagingSenderId: "902059536686",
    appId: "1:902059536686:web:be80e12bcb5aa8f4158abf"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const totalNumeros = 100;
  const valorBoleta = 20000;

  const grid = document.getElementById("grid");
  const availableNumbersText = document.getElementById("availableNumbers");
  const listaParticipantes = document.getElementById("listaParticipantes");
  const filtroEstado = document.getElementById("filtroEstado");
  const resumenEstadisticas = document.getElementById("resumenEstadisticas");
  const barraVendidos = document.getElementById("barraVendidos");
  const barraPendientes = document.getElementById("barraPendientes");
  const barraVendidosMeta = document.getElementById("barraVendidosMeta");
  const barraPendientesMeta = document.getElementById("barraPendientesMeta");
  const textoMeta = document.getElementById("textoMeta");
  const textoTotal = document.getElementById("textoTotal");

  const modal = document.getElementById("modal");
  const numeroModal = document.getElementById("numeroModal");
  const nombreInput = document.getElementById("nombreInput");
  const apellidoInput = document.getElementById("apellidoInput");
  const estadoInput = document.getElementById("estadoInput");
  const noticiasAdmin = document.getElementById("noticiasAdmin");

  let numeroSeleccionado = null;

  function actualizarMensaje() {
    const disponibles = [];
    document.querySelectorAll(".cell").forEach(cell => {
      if (!cell.classList.contains("green") && !cell.classList.contains("yellow")) {
        disponibles.push(cell.dataset.numero);
      }
    });
    availableNumbersText.textContent = disponibles.join(", ");
  }

  async function actualizarLista() {
    const registros = [];
    let vendidos = 0;
    let pendientes = 0;
    let disponibles = 0;
    const estadoFiltro = filtroEstado.value;
    const promises = [];

    for (let i = 0; i < totalNumeros; i++) {
      const numRef = doc(db, "numeros", i.toString());
      promises.push(getDoc(numRef).then(docSnap => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          if (data.estado === "vendido") vendidos++;
          else if (data.estado === "pendiente") pendientes++;
          else disponibles++;

          if (data.estado !== "disponible" && (estadoFiltro === "todos" || data.estado === estadoFiltro)) {
            registros.push(`#${i}: ${data.nombre || ""} ${data.apellido || ""} (${data.estado})`);
          }
        } else {
          disponibles++;
        }
      }));
    }

    await Promise.all(promises);

    listaParticipantes.innerHTML = registros.sort((a, b) => a.localeCompare(b)).join("<br>");
    const totalRecaudado = (vendidos + pendientes) * valorBoleta;
    resumenEstadisticas.innerHTML = `
      <strong>Resumen:</strong><br>
      Vendidos: ${vendidos} (COP $${vendidos * valorBoleta})<br>
      Pendientes: ${pendientes} (COP $${pendientes * valorBoleta})<br>
      Disponibles: ${disponibles}<br>
      <strong>Total recaudado: COP $${totalRecaudado}</strong>
    `;

    const porcentajeVendidosMeta = (vendidos * valorBoleta) / 600000 * 100;
    const porcentajePendientesMeta = (pendientes * valorBoleta) / 600000 * 100;
    barraVendidosMeta.style.width = `${porcentajeVendidosMeta}%`;
    barraPendientesMeta.style.width = `${porcentajePendientesMeta}%`;
    textoMeta.textContent = `Meta 600k: ${Math.round(porcentajeVendidosMeta + porcentajePendientesMeta)}%`;

    const porcentajeVendidos = (vendidos / totalNumeros) * 100;
    const porcentajePendientes = (pendientes / totalNumeros) * 100;
    barraVendidos.style.width = `${porcentajeVendidos}%`;
    barraPendientes.style.width = `${porcentajePendientes}%`;
    textoTotal.textContent = `Total: ${Math.round(porcentajeVendidos + porcentajePendientes)}%`;
  }

  for (let i = 0; i < totalNumeros; i++) {
    const cell = document.createElement("div");
    cell.classList.add("cell");
    cell.textContent = i;
    cell.dataset.numero = i;
    grid.appendChild(cell);

    const numRef = doc(db, "numeros", i.toString());

    onSnapshot(numRef, (docSnap) => {
      const data = docSnap.data();
      cell.classList.remove("green", "yellow", "blue");
      if (!data || data.estado === "disponible") {
  cell.title = "Disponible";
} else {
  if (data.estado === "vendido") cell.classList.add("green");
  else if (data.estado === "pendiente") cell.classList.add("yellow");
  else if (data.estado === "solicitado") cell.classList.add("blue"); // por confirmar
  cell.title = `${data.nombre || ""} ${data.apellido || ""}`.trim();
}

      actualizarMensaje();
    });

    cell.addEventListener("click", async () => {
      numeroSeleccionado = i;
      const snap = await getDoc(numRef);
      const data = snap.data() || { estado: "disponible" };
      numeroModal.textContent = i;
      nombreInput.value = data.nombre || "";
      apellidoInput.value = data.apellido || "";
      estadoInput.value = data.estado || "disponible";
      modal.style.display = "flex";
    });
  }

  window.guardarCambios = async () => {
    const numRef = doc(db, "numeros", numeroSeleccionado.toString());
    await setDoc(numRef, {
      estado: estadoInput.value,
      nombre: nombreInput.value,
      apellido: apellidoInput.value
    });
    cerrarModal();
    actualizarLista();
  };

  window.cerrarModal = () => {
    modal.style.display = "none";
  };

  filtroEstado.addEventListener("change", actualizarLista);
  actualizarLista();

  document.getElementById("copyBtn").addEventListener("click", () => {
    const texto = "Los n√∫meros disponibles son: " + availableNumbersText.textContent;
    navigator.clipboard.writeText(texto).then(() => {
      copyBtn.textContent = "¬°Copiado!";
      setTimeout(() => { copyBtn.textContent = "Copiar mensaje"; }, 2000);
    });
  });
  // üîÑ Solicitudes en tiempo real
    import { onSnapshot as onSnap, query as q } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    const solicitudesRef = collection(db, "solicitudes");
    onSnap(q(solicitudesRef), (snapshot) => {
      noticiasAdmin.innerHTML = "";
      if (snapshot.empty) {
        noticiasAdmin.innerHTML = "<p>No hay solicitudes en este momento.</p>";
        return;
      }
      snapshot.forEach(docSnap => {
        const s = docSnap.data();
        const id = docSnap.id;
        const div = document.createElement("div");
        div.classList.add("solicitud");
        div.innerHTML = `
          <strong>#${s.numero}</strong><br>
          Nombre: ${s.nombre} ${s.apellido}<br>
          M√©todo: ${s.metodo}<br>
          <button class="aprobar" onclick="aprobarSolicitud('${id}', ${s.numero}, '${s.nombre}', '${s.apellido}')">Aprobar</button>
          <button class="cancelar" onclick="rechazarSolicitud('${id}')">Cancelar</button>
        `;
        noticiasAdmin.appendChild(div);
      });
    });

    window.aprobarSolicitud = async (id, numero, nombre, apellido) => {
      const ref = doc(db, "numeros", numero.toString());
      await setDoc(ref, {
        nombre,
        apellido,
        estado: "vendido"
      });
      await deleteDoc(doc(db, "solicitudes", id));
    };

    window.rechazarSolicitud = async (id) => {
  try {
    // Obtener la solicitud antes de borrarla
    const solicitudSnap = await getDoc(doc(db, "solicitudes", id));

    if (solicitudSnap.exists()) {
      const data = solicitudSnap.data();
      const numero = data.numero.toString();

      // Marcar el n√∫mero como disponible
      await setDoc(doc(db, "numeros", numero), {
        estado: "disponible",
        nombre: "",
        apellido: ""
      });
    }

    // Eliminar la solicitud
    await deleteDoc(doc(db, "solicitudes", id));

  } catch (error) {
    console.error("Error al cancelar la solicitud:", error);
  }
};



    document.getElementById("copyBtn").addEventListener("click", () => {
      const disponibles = [...document.querySelectorAll(".cell")]
        .filter(c => !c.classList.contains("green") && !c.classList.contains("yellow"))
        .map(c => c.textContent);
      navigator.clipboard.writeText("N√∫meros disponibles: " + disponibles.join(", "));
      document.getElementById("copyBtn").textContent = "¬°Copiado!";
      setTimeout(() => {
        document.getElementById("copyBtn").textContent = "Copiar mensaje";
      }, 2000);
    });

</script>

</body>
</html>
